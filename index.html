import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { Search, MapPin, Star, Plus, Heart, CheckCircle, X, ChefHat, Navigation, Trash2, Apple, Check, ChevronRight, Loader2, Globe, Sparkles, AlertCircle, Save, Wand2, List, FolderPlus } from 'lucide-react';

// --- CONFIGURATION ---
const apiKey = ""; 

// --- COMPOSANTS LIQUID UI ---

const GlassCard = ({ children, className = "", onClick }) => (
  <div 
    onClick={onClick}
    className={`relative backdrop-blur-2xl bg-white/10 border border-white/20 shadow-[0_8px_32px_0_rgba(31,38,135,0.37)] ${className}`}
    style={{ borderRadius: '24px' }}
  >
    {children}
  </div>
);

const LiquidButton = ({ icon: Icon, active, onClick, label }) => (
  <button 
    onClick={onClick}
    className={`flex flex-col items-center gap-1 transition-all duration-500 group ${active ? 'scale-110' : 'scale-100 opacity-50 hover:opacity-100'}`}
  >
    <div className={`p-3 rounded-full transition-all duration-500 ${active ? 'bg-white/20 shadow-[0_0_20px_rgba(255,255,255,0.3)]' : 'bg-transparent'}`}>
        <Icon size={24} className={active ? 'text-white' : 'text-zinc-400'} />
    </div>
    {label && <span className="text-[10px] font-bold tracking-widest uppercase">{label}</span>}
  </button>
);

const InteractiveStars = ({ rating, onRate, size = 16, disabled = false }) => (
  <div className={`flex gap-1 ${disabled ? 'opacity-20' : ''}`}>
    {[1, 2, 3, 4, 5].map((star) => (
      <button 
        key={star} 
        disabled={disabled}
        onClick={(e) => { 
          if (disabled) return;
          e.stopPropagation(); 
          onRate && onRate(star); 
        }}
        className={`${!disabled ? 'cursor-pointer hover:scale-125 transition-transform' : 'cursor-not-allowed'}`}
      >
        <Star 
          size={size} 
          className={`${star <= rating ? 'fill-yellow-400 text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]' : 'text-white/20'}`} 
        />
      </button>
    ))}
  </div>
);

// --- MAIN APP ---
export default function ParisDiningApp() {
  const [restaurants, setRestaurants] = useState([
    {
      id: 1,
      name: "Girafe",
      address: "1 Place du Trocadéro, 75016 Paris",
      cuisine: "Fruits de mer",
      price: "€€€€",
      rating: 5,
      status: "visited",
      image: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?auto=format&fit=crop&w=800&q=80",
      note: "Vue imprenable sur la Tour Eiffel. Le plateau de fruits de mer est exceptionnel.",
      lists: ["Favoris"]
    },
    {
      id: 2,
      name: "Septime",
      address: "80 Rue de Charonne, 75011 Paris",
      cuisine: "Gastronomique",
      price: "€€€",
      rating: 4,
      status: "visited",
      image: "https://images.unsplash.com/photo-1559339352-11d035aa65de?auto=format&fit=crop&w=800&q=80",
      note: "Cuisine moderne et raffinée. Pensez à réserver très en avance.",
      lists: ["Favoris"]
    }
  ]);
  
  const [userLists, setUserLists] = useState(["Favoris", "À tester d'urgence", "Dîner Business"]);
  const [activeTab, setActiveTab] = useState('list');
  const [selectedStatus, setSelectedStatus] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [recommendations, setRecommendations] = useState([]);
  const [isSearching, setIsSearching] = useState(false);
  
  // Modals
  const [showAddResto, setShowAddResto] = useState(false);
  const [showAddList, setShowAddList] = useState(false);
  const [newListTitle, setNewListTitle] = useState("");
  const [newResto, setNewResto] = useState({ name: '', cuisine: '', status: 'wishlist' });

  // IA - Recommandations basées sur les goûts
  const generateRecommendations = async () => {
    setIsSearching(true);
    const favorites = restaurants.map(r => r.cuisine).join(', ');
    const prompt = `Basé sur ces goûts: ${favorites}, suggère 3 restaurants parisiens célèbres. Réponds en JSON: [{"name": "Nom", "reason": "Pourquoi ?", "cuisine": "Type"}]`;
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });
        const data = await response.json();
        const results = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
        setRecommendations(results);
    } catch (err) {
        console.error("Erreur Recos:", err);
    } finally {
        setIsSearching(false);
    }
  };

  const filteredRestaurants = useMemo(() => {
    return restaurants.filter(r => {
        const matchesStatus = selectedStatus === 'all' || r.status === selectedStatus;
        const matchesSearch = r.name?.toLowerCase().includes(searchQuery?.toLowerCase() || "");
        return matchesStatus && matchesSearch;
    });
  }, [restaurants, selectedStatus, searchQuery]);

  const addRestaurant = () => {
    if (!newResto.name) return;
    const item = {
        ...newResto,
        id: Date.now(),
        image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=800&q=80",
        rating: 0,
        lists: []
    };
    setRestaurants([item, ...restaurants]);
    setNewResto({ name: '', cuisine: '', status: 'wishlist' });
    setShowAddResto(false);
  };

  const createList = () => {
    if (!newListTitle) return;
    setUserLists([...userLists, newListTitle]);
    setNewListTitle("");
    setShowAddList(false);
  };

  const customStyles = `
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; background: black; margin: 0; padding: 0; overflow: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
  `;

  return (
    <div className="relative w-full h-screen overflow-hidden bg-black text-white font-sans selection:bg-white/20">
      <style dangerouslySetInnerHTML={{ __html: customStyles }} />
      
      {/* Background - Liquid Mesh */}
      <div className="absolute inset-0 pointer-events-none overflow-hidden">
          <div className="absolute top-[-20%] left-[-10%] w-[80%] h-[70%] bg-blue-600/30 blur-[150px] animate-pulse rounded-full" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-indigo-900/40 blur-[150px] rounded-full" />
      </div>

      <div className="relative z-10 flex flex-col h-full max-w-md mx-auto">
        
        <header className="pt-16 pb-6 px-8 flex justify-between items-start">
            <div>
                <h1 className="text-3xl font-black italic tracking-tighter uppercase drop-shadow-lg text-white">
                    Les Restos de Matt’s
                </h1>
                <p className="text-[10px] font-bold text-white/30 uppercase tracking-[0.3em] mt-1">Édition Paris Premium</p>
            </div>
            <div className="flex gap-2">
                <button 
                    onClick={generateRecommendations}
                    className="p-3 bg-white/10 backdrop-blur-xl rounded-full border border-white/20 text-blue-400 active:scale-90 transition-all"
                >
                    <Wand2 size={20} className={isSearching ? "animate-spin" : ""} />
                </button>
                <button 
                    onClick={() => setShowAddResto(true)}
                    className="p-3 bg-white text-black rounded-full shadow-lg active:scale-90 transition-all"
                >
                    <Plus size={20} />
                </button>
            </div>
        </header>

        {activeTab === 'list' && (
            <div className="px-8 mb-6">
                <div className="relative">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-white/30" size={18} />
                    <input 
                        type="text" 
                        placeholder="Filtrer mes adresses..."
                        className="w-full bg-white/5 border border-white/10 rounded-2xl py-3.5 pl-12 pr-12 text-xs font-medium focus:outline-none focus:bg-white/10 transition-all"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>
        )}

        <div className={`flex-1 overflow-y-auto px-6 pb-32 no-scrollbar space-y-8`}>
            
            {activeTab === 'list' && (
                <>
                    {recommendations.length > 0 && (
                        <section className="animate-in fade-in slide-in-from-top-4 duration-700">
                            <div className="flex items-center gap-2 mb-4">
                                <Sparkles size={14} className="text-yellow-400" />
                                <h2 className="text-[10px] font-black uppercase tracking-widest text-yellow-400">Suggestions pour Matt</h2>
                            </div>
                            <div className="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                                {recommendations.map((rec, i) => (
                                    <div key={i} className="min-w-[240px] glass p-5 rounded-[2rem] border-yellow-500/20">
                                        <h3 className="font-bold text-sm text-white">{rec.name}</h3>
                                        <p className="text-[10px] text-white/40 mb-3 italic">"{rec.reason}"</p>
                                        <button className="text-[10px] font-black text-yellow-500 uppercase tracking-widest flex items-center gap-1">
                                            Détails <ChevronRight size={10} />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    <section className="space-y-4">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-[10px] font-black uppercase tracking-widest text-white/30">Mon Carnet</h2>
                            <div className="flex gap-2">
                                {['all', 'wishlist', 'visited'].map(s => (
                                    <button 
                                        key={s}
                                        onClick={() => setSelectedStatus(s)}
                                        className={`text-[9px] font-bold px-3 py-1 rounded-full transition-all ${selectedStatus === s ? 'bg-white text-black' : 'text-white/40 bg-white/5'}`}
                                    >
                                        {s === 'all' ? 'TOUS' : s === 'wishlist' ? 'À TESTER' : 'FAIT'}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {filteredRestaurants.map(resto => (
                            <GlassCard key={resto.id} className="flex h-28 overflow-hidden active:scale-95 transition-all group cursor-pointer">
                                <img src={resto.image} className="w-28 h-full object-cover shrink-0" alt={resto.name} />
                                <div className="flex-1 p-4 flex flex-col justify-between">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-white text-sm">{resto.name}</h3>
                                        {resto.status === 'visited' ? <CheckCircle size={14} className="text-emerald-400" /> : <Heart size={14} className="text-rose-400" />}
                                    </div>
                                    <div className="flex justify-between items-end">
                                        <p className="text-[9px] text-white/40 font-black uppercase tracking-widest">{resto.cuisine}</p>
                                        <InteractiveStars rating={resto.rating || 0} disabled size={10} />
                                    </div>
                                </div>
                            </GlassCard>
                        ))}
                    </section>
                </>
            )}

            {activeTab === 'folders' && (
                <section className="space-y-6 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center">
                        <h2 className="text-[10px] font-black uppercase tracking-widest text-white/30">Mes Collections</h2>
                        <button onClick={() => setShowAddList(true)} className="flex items-center gap-2 text-[10px] font-bold text-blue-400 uppercase">
                            <FolderPlus size={14} /> Nouvelle Liste
                        </button>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        {userLists.map((listName, idx) => (
                            <GlassCard key={idx} className="aspect-square p-6 flex flex-col justify-between group active:scale-95 transition-all">
                                <div className="w-10 h-10 rounded-2xl bg-white/10 flex items-center justify-center text-white/40 group-hover:text-blue-400 transition-colors">
                                    <List size={20} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-sm leading-tight mb-1">{listName}</h3>
                                    <p className="text-[10px] text-white/30 font-bold uppercase tracking-widest">
                                        {restaurants.filter(r => r.lists?.includes(listName)).length} Lieux
                                    </p>
                                </div>
                            </GlassCard>
                        ))}
                    </div>
                </section>
            )}
        </div>

        {/* Modals Additionnelles */}
        {showAddResto && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm">
                <GlassCard className="w-full max-w-xs p-8 space-y-4 animate-in zoom-in-95 duration-200">
                    <h2 className="text-xl font-black italic uppercase tracking-tighter">Nouveau Resto</h2>
                    <input 
                        type="text" 
                        placeholder="Nom de l'établissement"
                        className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm"
                        value={newResto.name}
                        onChange={e => setNewResto({...newResto, name: e.target.value})}
                    />
                    <input 
                        type="text" 
                        placeholder="Type de cuisine"
                        className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm"
                        value={newResto.cuisine}
                        onChange={e => setNewResto({...newResto, cuisine: e.target.value})}
                    />
                    <div className="flex gap-2">
                        <button onClick={addRestaurant} className="flex-1 bg-white text-black py-3 rounded-xl font-bold text-xs uppercase tracking-widest">Ajouter</button>
                        <button onClick={() => setShowAddResto(false)} className="px-4 bg-white/10 rounded-xl"><X size={18}/></button>
                    </div>
                </GlassCard>
            </div>
        )}

        {showAddList && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm">
                <GlassCard className="w-full max-w-xs p-8 space-y-4 animate-in zoom-in-95 duration-200">
                    <h2 className="text-xl font-black italic uppercase tracking-tighter text-blue-400">Nouvelle Collection</h2>
                    <input 
                        type="text" 
                        placeholder="Titre de la liste (ex: Brunchs)"
                        className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm"
                        value={newListTitle}
                        onChange={e => setNewListTitle(e.target.value)}
                        autoFocus
                    />
                    <div className="flex gap-2">
                        <button onClick={createList} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-widest">Créer</button>
                        <button onClick={() => setShowAddList(false)} className="px-4 bg-white/10 rounded-xl"><X size={18}/></button>
                    </div>
                </GlassCard>
            </div>
        )}

        {/* Tab Bar Flottante */}
        <div className="absolute bottom-8 left-6 right-6 h-20 bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[2.5rem] flex items-center justify-around px-6 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            <LiquidButton icon={ChefHat} active={activeTab === 'list'} onClick={() => setActiveTab('list')} label="CARNET" />
            <LiquidButton icon={List} active={activeTab === 'folders'} onClick={() => setActiveTab('folders')} label="LISTES" />
            <LiquidButton icon={MapPin} active={activeTab === 'map'} onClick={() => setActiveTab('map')} label="CARTE" />
        </div>
      </div>
    </div>
  );
}
