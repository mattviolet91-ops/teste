<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Les Restos de Matt</title>
    
    <!-- Scripts avec fallback et chargement ordonné -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
      }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --matt-blue: #1D4ED8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .active-tab {
            color: #fff !important;
            background: rgba(29, 78, 216, 0.3);
            box-shadow: 0 0 20px rgba(29, 78, 216, 0.2);
        }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "firebase/firestore";

        // Expose to window for Babel script
        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } = window.FirebaseSDK;

        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'restos-matt-app';
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');

        // Initialisation sécurisée
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error", e);
        }

        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const icon = document.createElement('i');
                    icon.setAttribute('data-lucide', name);
                    icon.className = className;
                    iconRef.current.appendChild(icon);
                    window.lucide.createIcons();
                }
            }, [name, className]);
            return <span ref={iconRef} style={{ width: size, height: size, display: 'inline-flex' }}></span>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); 
            const [restaurants, setRestaurants] = useState([]);
            const [publicRestos, setPublicRestos] = useState([]);
            const [recommendations, setRecommendations] = useState([]);
            const [isAdding, setIsAdding] = useState(false);
            const [loadingRecs, setLoadingRecs] = useState(false);

            // Auth logic
            useEffect(() => {
                const startAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) { console.error("Auth failed", err); }
                };
                startAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // Real-time data
            useEffect(() => {
                if (!user || !db) return;

                const qPrivate = query(collection(db, 'artifacts', appId, 'users', user.uid, 'restaurants'));
                const unsub1 = onSnapshot(qPrivate, (s) => setRestaurants(s.docs.map(d => ({id: d.id, ...d.data(), type: 'private'}))), (e) => console.log(e));

                const qPublic = query(collection(db, 'artifacts', appId, 'public', 'data', 'restaurants'));
                const unsub2 = onSnapshot(qPublic, (s) => setPublicRestos(s.docs.map(d => ({id: d.id, ...d.data(), type: 'public'}))), (e) => console.log(e));

                return () => { unsub1(); unsub2(); };
            }, [user]);

            const fetchAIRecommendations = async () => {
                if (restaurants.length === 0 && publicRestos.length === 0) return;
                setLoadingRecs(true);
                const list = [...restaurants, ...publicRestos].map(r => r.name).join(', ');
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Basé sur ces restaurants à Paris: ${list}, suggère 3 nouveaux restos. Répond uniquement en JSON: {"recos": [{"name": "Nom", "cuisine": "Style", "desc": "Pourquoi?"}]}` }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await res.json();
                    const parsed = JSON.parse(data.candidates[0].content.parts[0].text);
                    setRecommendations(parsed.recos);
                } catch (e) {
                    console.error("AI Error", e);
                } finally {
                    setLoadingRecs(false);
                }
            };

            useEffect(() => {
                if (view === 'ai' && recommendations.length === 0) fetchAIRecommendations();
            }, [view]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = {
                    name: fd.get('name'),
                    cuisine: fd.get('cuisine'),
                    note: fd.get('note'),
                    userId: user.uid,
                    timestamp: Date.now()
                };
                const isPrivate = fd.get('privacy') === 'on';
                const colPath = isPrivate 
                    ? collection(db, 'artifacts', appId, 'users', user.uid, 'restaurants')
                    : collection(db, 'artifacts', appId, 'public', 'data', 'restaurants');
                
                await addDoc(colPath, data);
                setIsAdding(false);
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-black relative overflow-hidden">
                    {/* Background Aura */}
                    <div className="absolute top-[-10%] left-[-10%] w-[120%] h-[40%] bg-blue-900/20 blur-[100px] pointer-events-none"></div>

                    <header className="px-6 pt-12 pb-6 flex justify-between items-center relative z-10">
                        <h1 className="text-2xl font-black italic tracking-tighter uppercase leading-none">
                            <span className="text-blue-600">Restos</span><br/>de Matt
                        </h1>
                        <button onClick={() => setIsAdding(true)} className="w-12 h-12 glass rounded-2xl flex items-center justify-center text-blue-500 active:scale-90 transition-transform">
                            <LucideIcon name="plus" size={24} />
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto no-scrollbar px-6 pb-32">
                        {view === 'list' ? (
                            <div className="fade-in space-y-8">
                                <section>
                                    <h2 className="text-[10px] font-bold uppercase tracking-[0.2em] text-white/30 mb-4">Mes Adresses</h2>
                                    <div className="space-y-3">
                                        {restaurants.map(r => (
                                            <div key={r.id} className="glass rounded-3xl p-5 border-l-4 border-blue-600/50">
                                                <h3 className="font-bold text-lg">{r.name}</h3>
                                                <p className="text-xs text-white/40 uppercase tracking-widest">{r.cuisine}</p>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section>
                                    <h2 className="text-[10px] font-bold uppercase tracking-[0.2em] text-white/30 mb-4">Partagés</h2>
                                    <div className="space-y-3">
                                        {publicRestos.map(r => (
                                            <div key={r.id} className="glass rounded-3xl p-5 border-l-4 border-white/10">
                                                <h3 className="font-bold text-lg">{r.name}</h3>
                                                <p className="text-xs text-white/40 uppercase tracking-widest">{r.cuisine}</p>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        ) : (
                            <div className="fade-in space-y-6">
                                <div className="mb-6">
                                    <h2 className="text-2xl font-black italic">Conseils IA</h2>
                                    <p className="text-xs text-white/40">Basé sur tes préférences actuelles</p>
                                </div>
                                {loadingRecs ? (
                                    <div className="flex justify-center py-20 animate-pulse text-blue-500">
                                        <LucideIcon name="sparkles" className="animate-spin" />
                                    </div>
                                ) : (
                                    recommendations.map((rec, i) => (
                                        <div key={i} className="glass p-6 rounded-[2.5rem] border border-blue-500/20">
                                            <h3 className="text-xl font-bold mb-1 text-blue-400">{rec.name}</h3>
                                            <p className="text-[10px] font-bold uppercase text-white/30 mb-4">{rec.cuisine}</p>
                                            <p className="text-sm opacity-70 leading-relaxed italic">"{rec.desc}"</p>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-8 left-8 right-8 h-20 glass rounded-[2.5rem] flex items-center justify-around px-2 z-50 max-w-md mx-auto">
                        <button onClick={() => setView('list')} className={`flex-1 flex flex-col items-center gap-1 p-4 rounded-3xl transition-all ${view === 'list' ? 'active-tab' : 'opacity-40'}`}>
                            <LucideIcon name="list" size={20} />
                            <span className="text-[8px] font-bold uppercase">Ma Liste</span>
                        </button>
                        <button onClick={() => setView('ai')} className={`flex-1 flex flex-col items-center gap-1 p-4 rounded-3xl transition-all ${view === 'ai' ? 'active-tab' : 'opacity-40'}`}>
                            <LucideIcon name="sparkles" size={20} />
                            <span className="text-[8px] font-bold uppercase">Conseils</span>
                        </button>
                    </nav>

                    {/* Add Drawer */}
                    {isAdding && (
                        <div className="fixed inset-0 z-[100] flex items-end">
                            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setIsAdding(false)}></div>
                            <form onSubmit={handleSubmit} className="relative w-full glass rounded-t-[3rem] p-8 border-t border-white/20 fade-in">
                                <div className="w-12 h-1 bg-white/20 rounded-full mx-auto mb-8"></div>
                                <h3 className="text-2xl font-black mb-6 italic">Nouveau Resto</h3>
                                <div className="space-y-4">
                                    <input name="name" required placeholder="Nom du restaurant" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500" />
                                    <input name="cuisine" placeholder="Cuisine (ex: Japonais)" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500" />
                                    <div className="flex items-center justify-between glass p-4 rounded-2xl">
                                        <span className="text-sm font-bold">Privé ?</span>
                                        <input type="checkbox" name="privacy" defaultChecked className="w-5 h-5 accent-blue-600" />
                                    </div>
                                    <button type="submit" className="w-full py-4 bg-blue-600 rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg active:scale-95 transition-all">Ajouter</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
